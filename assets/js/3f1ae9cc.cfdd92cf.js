"use strict";(self.webpackChunkaminsaied=self.webpackChunkaminsaied||[]).push([[7048],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>d});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(n),d=i,h=u["".concat(s,".").concat(d)]||u[d]||m[d]||r;return n?a.createElement(h,o(o({ref:t},c),{},{components:n})):a.createElement(h,o({ref:t},c))}));function d(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var p=2;p<r;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},2769:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>m,frontMatter:()=>r,metadata:()=>l,toc:()=>p});var a=n(7462),i=(n(7294),n(3905));const r={title:"API Management",sidebar_position:0},o=void 0,l={unversionedId:"dsref/azure/api-management-service",id:"dsref/azure/api-management-service",title:"API Management",description:"Resources",source:"@site/docs/dsref/azure/api-management-service.md",sourceDirName:"dsref/azure",slug:"/dsref/azure/api-management-service",permalink:"/docs/dsref/azure/api-management-service",draft:!1,tags:[],version:"current",sidebarPosition:0,frontMatter:{title:"API Management",sidebar_position:0},sidebar:"dsrefSidebar",previous:{title:"Azure",permalink:"/docs/category/azure"},next:{title:"Azure Web Apps",permalink:"/docs/dsref/azure/webapp"}},s={},p=[{value:"Resources",id:"resources",level:2},{value:"API Management Service",id:"api-management-service",level:2},{value:"Test API",id:"test-api",level:3},{value:"Test api with curl",id:"test-api-with-curl",level:4},{value:"Add CORS policy to our API",id:"add-cors-policy-to-our-api",level:3},{value:"The problem: CORS",id:"the-problem-cors",level:4},{value:"The solution: Add a CORS policy",id:"the-solution-add-a-cors-policy",level:4},{value:"Add key to incoming requests",id:"add-key-to-incoming-requests",level:3}],c={toc:p};function m(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"resources"},"Resources"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://docs.microsoft.com/en-us/azure/architecture/microservices/design/gateway"},"Microservices")," (high level design)"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://docs.microsoft.com/en-us/azure/api-management/import-and-publish"},"API Management Service")," (tutorial)"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://docs.microsoft.com/en-us/azure/api-management/api-management-howto-use-managed-service-identity"},"Managed service identity")," (tutorial)")),(0,i.kt)("h2",{id:"api-management-service"},"API Management Service"),(0,i.kt)("p",null,"Goal: Import an (OpenAPI Specification) backend API in JSON format into Azure API Management. Microsoft provides the backend API and hosts it on Azure.  "),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},'If gpt3 api doesn\'t meet OAI specification just use a "blank" api template'))),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Create api-management-service in Azure portal",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},'Note: Selected "Development tier" for pricing (no SLA)'),(0,i.kt)("li",{parentName:"ul"},"Can be linked to AppInsights for monitoring - need to create an AppInsights instance"),(0,i.kt)("li",{parentName:"ul"},"Enabled system assigned managed identities to enable authentication"),(0,i.kt)("li",{parentName:"ul"},"Note: Deployment of the resource can take >30 minutes, so be patient ;-)"))),(0,i.kt)("li",{parentName:"ol"},"Test API",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"See section below"))),(0,i.kt)("li",{parentName:"ol"},"Add CORS policy to out API",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"See section below"))),(0,i.kt)("li",{parentName:"ol"},"Add key to income requests",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"See section below")))),(0,i.kt)("h3",{id:"test-api"},"Test API"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Input:")," Working endpoint from azureml that can be called e.g. like this"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'curl http://51.143.104.146:80/api/v1/service/autome-endpoint/score -H "Content-Type: application/json" -H "Authorization: Bearer $apikey" -d \'{"prompt": "what did Wittgenstein become =>", "max_length": 50}\'\n')),(0,i.kt)("p",null,"where the apikey is available from ml.azure.com."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Goal:"),' define a "blank api" using Azure API Management service that "wraps" this endpoint.'),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Find the resource in Azure Portal > select the API tab.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},'Create an API > "Blank API" > Select "Full" to see additional configuration options'),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Display name: Autome Endpoint"),(0,i.kt)("li",{parentName:"ul"},"Name: autome-endpoint"),(0,i.kt)("li",{parentName:"ul"},"Description: Endpoint serving finetuned gpt-2 model"),(0,i.kt)("li",{parentName:"ul"},"Web service URL: ",(0,i.kt)("a",{parentName:"li",href:"http://51.143.104.146:80/api/v1/service/autome-endpoint"},"http://51.143.104.146:80/api/v1/service/autome-endpoint"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Note: this DOES NOT include the ",(0,i.kt)("inlineCode",{parentName:"li"},"/score")," suffix"))),(0,i.kt)("li",{parentName:"ul"},"URL Scheme: http"),(0,i.kt)("li",{parentName:"ul"},'API URL suffix: autome\nGateways: "Managed" (this should be automatically populated)'))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Add an operation (we will add ",(0,i.kt)("inlineCode",{parentName:"p"},"/score"),")"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Go to Design tab > + Operation",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Display name: Score"),(0,i.kt)("li",{parentName:"ul"},"Name: score"),(0,i.kt)("li",{parentName:"ul"},"URL: POST /score"))))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},'Test the endpoint: Find the "Test" tab near the "Design" tab.'),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Add headers:"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Authorization: Bearer ",(0,i.kt)("inlineCode",{parentName:"li"},"<api-key>")),(0,i.kt)("li",{parentName:"ul"},"Content-Type: application/json"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Add a request body"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{"prompt": "what did Wittgenstein become =>", "max_length": 50}\n'))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Click Send and wait for the response."),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre"},'HTTP/1.1 200 OK\n\ncache-control: max-age=0, private, must-revalidate\ncontent-length: 240\ncontent-type: application/json\ndate: Wed, 07 Apr 2021 18:57:06 GMT\nocp-apim-apiid: autome-endpoint\nocp-apim-operationid: score\nocp-apim-subscriptionid: master\nocp-apim-trace-location: https://apimstbfwzj8bvczuq2ugnwq.blob.core.windows.net/apiinspectorcontainer/AgpenpXg3kGGMNWQXVlUmA2-3?sv=2019-07-07&sr=b&sig=AbA%2Bu6FALawalSuNesS9eQOwIJA8QSmPG0x0iYFkWlY%3D&se=2021-04-08T18%3A56%3A57Z&sp=r&traceId=fa3a5a23daed4a3988d17401a3ee7b82\nvary: Origin\nx-ms-request-id: 0aaaad60-6e7d-4a33-85eb-d8d485827399\nx-ms-run-function-failed: False\n"{\\"output\\": \\"what did Wittgenstein become => I was just thinking to myself... That was crazy. I\'m sure he was a lot more serious than we know :-)\\", \\"prompt\\": \\"what did Wittgenstein become =>\\", \\"num_return_sequences\\": 1}"\n')))))),(0,i.kt)("h4",{id:"test-api-with-curl"},"Test api with curl"),(0,i.kt)("p",null,"You can replicate this test from the command line:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'curl http://babel-api-manager.azure-api.net/autome/score -H "Authorization: Bearer <from ml.azure.com>" -H "Content-Type: application/json" -H "ocp-apim-subscriptionid: master" -H "Ocp-Apim-Subscription-Key: <from-portal>" -d \'{"prompt": "what did Wittgenstein become =>", "max_length": 50}\'\n')),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'"{\\"output\\": \\"what did Wittgenstein become => He was the first American to work in the post. He was very nice - he was also the youngest one to speak!\\", \\"prompt\\": \\"what did Wittgenstein become =>\\", \\"num_return_sequences\\": 1}"\n')),(0,i.kt)("p",null,"Note here that the apikey from the ml.azure.com endpoint and the subscription key from portal.azure.com are used to authenticate the request."),(0,i.kt)("h3",{id:"add-cors-policy-to-our-api"},"Add CORS policy to our API"),(0,i.kt)("p",null,"By now we have the following setup:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"An endpoint from azureml, e.g.,")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'curl http://51.143.104.146:80/api/v1/service/autome-endpoint/score -H "Content-Type: application/json" -H "Authorization: Bearer $apikey" -d \'{"prompt": "what did Wittgenstein become =>", "max_length": 50, "num_return_sequences": 2}\'\n\n"{\\"output\\": [\\"what did Wittgenstein become => He\'s really good at predicting. He got this:\\\\n\\\\n\\\\\\"The Great Depression started in the midst of the Great American Manufacturing Experiment... It went well, but slowly, in large part because there were a lot\\", \\"what did Wittgenstein become => I think I know who Wittgen...\\"], \\"prompt\\": \\"what did Wittgenstein become =>\\", \\"num_return_sequences\\": 2}"\n')),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"An API management service endpoint that wraps the above endpoint, e.g.,")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'curl http://babel-api-manager.azure-api.net/autome/score -H "Authorization: Bearer $apikey" -H "Content-Type: application/json" -H "ocp-apim-subscriptionid: master" -H "Ocp-Apim-Subscription-Key: $subkey" -d \'{"prompt": "what did Wittgenstein become =>", "max_length": 50}\'\n\n"{\\"output\\": \\"what did Wittgenstein become => Yeah, I\'ve been a bit sceptical. I thought he was a \\\\\\"maniac\\\\\\".\\", \\"prompt\\": \\"what did Wittgenstein become =>\\", \\"num_return_sequences\\": 1}"\n')),(0,i.kt)("h4",{id:"the-problem-cors"},"The problem: CORS"),(0,i.kt)("p",null,"We want to call this endpoint from our application. In our case that is a React\ncomponent inside a docusaurus generated single page application. In that component\nwe call the api something like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const apikey = \"...\"; //set these secrets\nconst subkey = \"...\"; //set these secrets\nconst headers = {\n    'Content-Type': 'application/json',\n    'Authorization': `Bearer ${apikey}`,\n    'Ocp-Apim-Subscription-Key': `${subkey}`,\n    'ocp-apim-subscriptionid': 'master',\n}\nconst data = {\n    'prompt': prompt,  // this comes from client text box\n    'max_length': 5,\n    'num_return_sequences': 2,\n}\nconsole.log(data)\naxios.post(\n    \"http://babel-api-manager.azure-api.net/autome/score\", data, { headers: headers }\n).then(result => {\n    // do something with the response\n})\n")),(0,i.kt)("p",null,"Testing this code locally gives an error"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"Access to XMLHttpRequest at 'http://babel-api-manager.azure-api.net/autome/score' from origin 'http://localhost:3000' has been blocked by CORS policy: Response to preflight request doesn't pass access control check: No 'Access-Control-Allow-Origin' header is present on the requested resource.\n")),(0,i.kt)("p",null,"But it will run successfully if we launch our browser like this"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"'C:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe'  --disable-web-security --disable-gpu  --user-data-dir=~/chromeTemp\n")),(0,i.kt)("h4",{id:"the-solution-add-a-cors-policy"},"The solution: Add a CORS policy"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Select your endpoint in the Azure API Management service in the Azure portal."),(0,i.kt)("li",{parentName:"ul"},"Add a cors policy to your inbound processing policies")),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("ol",{parentName:"div"},(0,i.kt)("li",{parentName:"ol"},"Remove the existing ",(0,i.kt)("inlineCode",{parentName:"li"},"<base />")," policy from inbound section."),(0,i.kt)("li",{parentName:"ol"},"Add the origins of your desired webpage here otherwise it won't work! We include\nlocalhost:3000 for local testing.")))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-xml"},'<policies>\n    <inbound>\n        <cors allow-credentials="true">\n            <allowed-origins>\n                <origin>https://babel-webapp.azurewebsites.net</origin>\n                <origin>http://localhost:3000</origin>\n            </allowed-origins>\n            <allowed-methods preflight-result-max-age="300">\n                <method>*</method>\n            </allowed-methods>\n            <allowed-headers>\n                <header>*</header>\n            </allowed-headers>\n            <expose-headers>\n                <header>*</header>\n            </expose-headers>\n        </cors>\n    </inbound>\n    <backend>\n        <base />\n    </backend>\n    <outbound>\n        <base />\n    </outbound>\n    <on-error>\n        <base />\n    </on-error>\n</policies>\n')),(0,i.kt)("h3",{id:"add-key-to-incoming-requests"},"Add key to incoming requests"),(0,i.kt)("p",null,"Goal: Abstract secrets from client i.e. do not store apikey in javascript logic calling the api"),(0,i.kt)("p",null,"Solution: Add the authorization header to incoming requests in API manager"),(0,i.kt)("p",null,"To do so, add the following policy to the inbound section:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-xml"},'<set-header name="Authorization" exists-action="override">\n    <value>Bearer "your-api-key"</value>\n</set-header>\n')),(0,i.kt)("p",null,"To look something like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-xml"},'<policies>\n    <inbound>\n        <cors allow-credentials="true">\n            <allowed-origins>\n                <origin>https://babel-webapp.azurewebsites.net</origin>\n                <origin>http://localhost:3000</origin>\n            </allowed-origins>\n            <allowed-methods preflight-result-max-age="300">\n                <method>*</method>\n            </allowed-methods>\n            <allowed-headers>\n                <header>*</header>\n            </allowed-headers>\n            <expose-headers>\n                <header>*</header>\n            </expose-headers>\n        </cors>\n        <set-header name="Authorization" exists-action="override">\n            <value>Bearer "your-api-key"</value>\n        </set-header>\n    </inbound>\n    <backend>\n        <base />\n    </backend>\n    <outbound>\n        <base />\n    </outbound>\n    <on-error>\n        <base />\n    </on-error>\n</policies>\n')))}m.isMDXComponent=!0}}]);