"use strict";(self.webpackChunkaminsaied=self.webpackChunkaminsaied||[]).push([[7533],{3905:(e,r,n)=>{n.d(r,{Zo:()=>p,kt:()=>d});var t=n(7294);function a(e,r,n){return r in e?Object.defineProperty(e,r,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[r]=n,e}function o(e,r){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);r&&(t=t.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,t)}return n}function i(e){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{};r%2?o(Object(n),!0).forEach((function(r){a(e,r,n[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))}))}return e}function l(e,r){if(null==e)return{};var n,t,a=function(e,r){if(null==e)return{};var n,t,a={},o=Object.keys(e);for(t=0;t<o.length;t++)n=o[t],r.indexOf(n)>=0||(a[n]=e[n]);return a}(e,r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(t=0;t<o.length;t++)n=o[t],r.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var c=t.createContext({}),s=function(e){var r=t.useContext(c),n=r;return e&&(n="function"==typeof e?e(r):i(i({},r),e)),n},p=function(e){var r=s(e.components);return t.createElement(c.Provider,{value:r},e.children)},u={inlineCode:"code",wrapper:function(e){var r=e.children;return t.createElement(t.Fragment,{},r)}},m=t.forwardRef((function(e,r){var n=e.components,a=e.mdxType,o=e.originalType,c=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),m=s(n),d=a,k=m["".concat(c,".").concat(d)]||m[d]||u[d]||o;return n?t.createElement(k,i(i({ref:r},p),{},{components:n})):t.createElement(k,i({ref:r},p))}));function d(e,r){var n=arguments,a=r&&r.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=m;var l={};for(var c in r)hasOwnProperty.call(r,c)&&(l[c]=r[c]);l.originalType=e,l.mdxType="string"==typeof e?e:a,i[1]=l;for(var s=2;s<o;s++)i[s]=n[s];return t.createElement.apply(null,i)}return t.createElement.apply(null,n)}m.displayName="MDXCreateElement"},6443:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>c,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>l,toc:()=>s});var t=n(7462),a=(n(7294),n(3905));const o={title:"Azure ML Docker Examples",sidebar_position:1},i=void 0,l={unversionedId:"dsref/azure/docker/azure-docker-examples",id:"dsref/azure/docker/azure-docker-examples",title:"Azure ML Docker Examples",description:"Some examples of working with docker in Azure (ML).",source:"@site/docs/dsref/azure/docker/azure-docker-examples.md",sourceDirName:"dsref/azure/docker",slug:"/dsref/azure/docker/azure-docker-examples",permalink:"/docs/dsref/azure/docker/azure-docker-examples",draft:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{title:"Azure ML Docker Examples",sidebar_position:1},sidebar:"dsrefSidebar",previous:{title:"Docker Basics",permalink:"/docs/dsref/azure/docker/docker-basics"},next:{title:"Private Wheels",permalink:"/docs/dsref/azure/docker/private-wheel"}},c={},s=[{value:"Example: Pull an image from MCR and run locally",id:"example-pull-an-image-from-mcr-and-run-locally",level:2},{value:"Example: Dockerfiles &amp; Azure ML",id:"example-dockerfiles--azure-ml",level:2}],p={toc:s};function u(e){let{components:r,...n}=e;return(0,a.kt)("wrapper",(0,t.Z)({},p,n,{components:r,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"Some examples of working with docker in Azure (ML)."),(0,a.kt)("h2",{id:"example-pull-an-image-from-mcr-and-run-locally"},"Example: Pull an image from MCR and run locally"),(0,a.kt)("p",null,"To pull this image"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"mcr.microsoft.com/azureml/bert:pretrain-openmpi3.1.2-cuda10.0-cudnn7-ubuntu16.04\n")),(0,a.kt)("p",null,"and run it locally, do:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"$ docker pull mcr.microsoft.com/azureml/bert:pretrain-openmpi3.1.2-cuda10.0-cudnn7-ubuntu16.04\n$ docker run -it mcr.microsoft.com/azureml/bert:pretrain-openmpi3.1.2-cuda10.0-cudnn7-ubuntu16.04\nroot@99ab01080c61:/#\n")),(0,a.kt)("h2",{id:"example-dockerfiles--azure-ml"},"Example: Dockerfiles & Azure ML"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Step 1 - Write dockerfile"),"  "),(0,a.kt)("p",null,"Start with a dockerfile"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-dockerfile"},"# ./Dockerfile\nFROM mcr.microsoft.com/azureml/base\n\nRUN pip install --upgrade pip\nRUN pip install azureml-core==1.7.0 azureml-sdk==1.7.0 scikit-learn==0.23.1\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Step 2 - Azure Container Registry"),"  "),(0,a.kt)("p",null,"Push this image to the Azure Container Registry associated to your Azure ML Workspace:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Find the name of your existing Azure Container Registries (there will be one created when you spin up an Azure ML workspace)"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"az ml workspace show -w <myworkspace> -g <resourcegroup> --query containerRegistry\n")),(0,a.kt)("p",{parentName:"li"},"You'll get something like this:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"/subscriptions/<subscription_id>/resourceGroups/<resource_group>/providers/\n    Microsoft.ContainerRegistry/registries/<registry_name>\n")),(0,a.kt)("p",{parentName:"li"},"Make a note of the ",(0,a.kt)("inlineCode",{parentName:"p"},"<registry_name>"),"."),(0,a.kt)("p",{parentName:"li"},'??? failure "Error: Workspace not found"'),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},'If you get an error that the workspace cannot be found you may need to set your subscription:\n\n```bash\n# by name\naz account set --subscription "My Demos"\n\n# or by id\naz account set --subscription 42ae47bd-b19b-42c1-b0b9-19fd5be9d51b\n```\n')))),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Login:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"az acr login --name <registry_name>\n"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Build your image in the cloud. Navigate to your dockerfile and run this to create and push the image into your Azure Container Registry:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"az acr build --image myimage:v1 --registry <registry_name> --file Dockerfile .\n")))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Step 3 - Reference the container in your Azure ML launch script"),"  "),(0,a.kt)("p",null,"In this example we use the Azure ML python sdk to kick off the job. We need to reference our image here."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},'# get workspace\nws = Workspace.get(...)\n\n# Add training script to run config\nsrc = ScriptRunConfig(\n    source_directory=".",\n    script="script.py",\n)\n\n# to run on local compute\nsrc.run_config.environment.python.user_managed_dependencies = True\nsrc.run_config.environment.docker.base_image = <azure-container-registry-image-name>\n\n# Create experiment\nexp = Experiment(...)\n\n# Submit run\nrun = exp.submit(src)\n')),(0,a.kt)("p",null,"To be explicit, when I ran the command"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"az acr build --image amsaied/async:v1 --registry amsaiedamlws8d0e0159 --file dockerfile .\n")),(0,a.kt)("p",null,"Within the output you'll see this:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"image:\n    registry: amsaiedamlws8d0e0159.azurecr.io\n    repository: amsaied/async\n    tag: v1\n")),(0,a.kt)("p",null,"which I can reference like this"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"amsaiedamlws8d0e0159.azurecr.io/amsaied/async:v1\n")),(0,a.kt)("p",null,"for example"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},"src.run_config.environment.python.user_managed_dependencies = True\nsrc.run_config.environment.docker.base_image = 'amsaiedamlws8d0e0159.azurecr.io/amsaied/async:v1'\n")),(0,a.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,a.kt)("div",{parentName:"div",className:"admonition-heading"},(0,a.kt)("h5",{parentName:"div"},(0,a.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,a.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,a.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),'"Warning: AML + WSL != Docker"')),(0,a.kt)("div",{parentName:"div",className:"admonition-content"},(0,a.kt)("p",{parentName:"div"},"As of 2020/06/12, Azure ML does not support running docker locally from WSL."))))}u.isMDXComponent=!0}}]);